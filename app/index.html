<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Causeway</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="styles/main.css">

		<link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>

		<script type="text/javascript" src="js/Tone.min.js"></script>
        <script type="text/javascript" src="js/nexusUI.js"></script>

		<script src="/socket.io/socket.io.js"></script>
	</head>
	<body>

		<div class="sec sw">
			<h1 onclick="causeSound.triggerCauseway();">Causeway</h1>
			<p>Words | <strong>Vincent A. Cellucci</strong></p>
			<p>Audio | <strong>Jesse Allison</strong></p>
			<p>Visuals | <strong>Derick Ostrenko</strong></p>
			<p><em>Instructions: Tapping is the new snapping.</em></p>
			
			<svg version="1.1" x="0px" y="0px" viewBox="0 0 640 480">
	<style>
		.st0{
			fill:none;stroke:#4D4D4D;
			stroke-width:6;
			stroke-miterlimit:10;

		}
	</style>

	<path class="st0" d="M412.9,127.5c-130.8,62.6-278,62.6-408.9,0C24.5,86.4,45,45.2,65.5,4c92.4,43.5,193.6,43.5,286,0
		C371.9,45.2,392.4,86.4,412.9,127.5z"/>
	<line class="st0" x1="159.1" y1="30.7" x2="136.7" y2="168.4"/>
	<line class="st0" x1="257.9" y1="30.7" x2="279.5" y2="168.4"/>
	<path class="st0" d="M382.5,64.3c-111.4,54.3-236.2,54.3-347.7,0"/>
	<line class="st0" x1="53.3" y1="251" x2="368.3" y2="251"/>
	<rect x="53.3" y="199" class="st0" width="315" height="35"/>

</svg>

		</div>

		<div id="causeway-text"></div>

		<script>
			var socket = io.connect(':8000/');
			var myColor = getRandomColor();
			document.getElementsByTagName("body")[0].style.borderLeft = "15px solid " + myColor;

			// socket.emit('addme', {name: "a_user", color: myColor});

			registerWithServer();

			socket.on('chat', function(data){
				console.log("chat: " + data);
			});

			socket.on('setSection', function(data) {
				console.log(data);
				console.log("the section is now: " + data.title);

				if(data.title == "Welcome") {
					scrollto(data.sect);
				}
				
				if(data.title !== undefined){
					
					var otherClasses = document.querySelectorAll('.sec'),
					    i = 0,
					    l = otherClasses.length;

					for (i; i < l; i++) {
					    otherClasses[i].style.display = 'none';
					}

					document.getElementsByClassName("s"+data.sect)[0].style.display = 'block';

					scrollto(data.sect);

				}
				
			});

			function scrollto(element){ 
			     var ele = document.getElementsByClassName("s"+element)[0];
			     if (ele) {
			     	window.scrollTo(0, ele.offsetTop);
			     }
			}

			socket.on('itemback', function(data){
				console.log("itemback: " + data.phrase);
				var elements = document.getElementsByClassName(data.phrase);
				// for(var i = elements.length - 1; i >= 0; --i) {
					elements[0].className += " clicked";
					// elements[i].style.color = data.color;
					// elements[i].style.backgroundColor = data.color;
				// }
			});

			function clickgo() {
				var elements = document.getElementsByClassName(this.className);
				// for(var i = elements.length - 1; i >= 0; --i) {
					socket.emit('item', elements[0].className.split(" ")[1]);
					// console.log(elements[i].className.split(" ")[1]);
					elements[0].className += " clicked";
					// elements[i].style.color = myColor;
					elements[0].style.backgroundColor = myColor;
				// }
			}

			window.onload = function() {

				var xhr= new XMLHttpRequest();
				xhr.open('GET', 'data/causeway.html', true);
				xhr.onreadystatechange= function() {
				    if (this.readyState!==4) return;
				    if (this.status!==200) return; // or whatever error handling you want
				    document.getElementById("causeway-text").innerHTML= this.responseText;
				    addEvents();
				};
				xhr.send();

				function addEvents() {
					var phrases = document.getElementsByClassName('phrase');
					for (var i = 0; i < phrases.length; i++) {
						phrases[i].addEventListener("click", clickgo, false);
						//phrases[i].addEventListener("touchstart", clickgo, false);
					}
				}

			};

			function getRandomColor() {
				var letters = '0123456789ABCDEF'.split('');
				var color = '#';
				for (var i = 0; i < 6; i++ ) {
				    color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}

			function registerWithServer() {
            	socket.emit('addme', {name: "a_user", color: myColor, note: causeSound.Pitch, location: myLocation});
            	document.getElementByID("overlay").style.display = 'none';
    		}

    		var CauseSound = function () {
	            this.tone = new Tone();
	            this.synth = new Tone.SimpleSynth({
	                    "oscillator" : {
	                            "type" : "sine"
	             },
	             "envelope" : {
	                    "attack" : 2.0,
	                    "decay" : 0.5,
	                    "sustain" : 0.8,
	                    "release" : 2.0
	             }
	            }).toMaster();

	            this.player = new Tone.Player("data/wavs/001-Causeway.wav").toMaster();

	            this.pitchCollection = [55, 57, 59, 61, 62, 64, 66, 67, 68, 69, 71, 73, 75, 76, 78, 80, 82, 83];

	            this.pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];


	            this.playPitch = function () {
	                    this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch), 5);
	            }

	            this.playCauseway = function() {
	                    this.player.start();
	            }

	            this.triggerCauseway = function() {
	                     this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch), 5);
	                     this.player.start();
	                     socket.emit('triggerCauseway', causeSound.Pitch);
	             }
            }

            var causeSound = new CauseSound();
            var myLocation = {};

            causeSound.playPitch();

		</script>

	</body>
</html>
